<!DOCTYPE HTML>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Implementing a Job queue with SQLx and Postgres</title>
    <meta name="description" content="An example of async postgres in rust" />
    <link rel="alternate" type="application/rss+xml" href="/rss.xml" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <style>html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,footer,header,nav,section{display:block}h1{font-size:2em;margin:0.67em 0}figcaption,figure,main{display:block}hr{box-sizing:content-box;height:0;overflow:visible}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}address{font-style:normal}b,strong{font-weight:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:"SF Mono","Segoe UI Mono","Roboto Mono",Menlo,Courier,monospace;font-size:1em}dfn{font-style:italic}small{font-size:80%;font-weight:400}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-0.25em}sup{top:-0.5em}audio,video{display:inline-block}audio:not([controls]){display:none;height:0}img{border-style:none}svg:not(:root){overflow:hidden}button,input,optgroup,select,textarea{font-family:inherit;font-size:inherit;line-height:inherit;margin:0}button,input{overflow:visible}button,select{text-transform:none}button,html [type="button"],[type="reset"],[type="submit"]{-webkit-appearance:button}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0}fieldset{border:0;margin:0;padding:0}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{display:inline-block;vertical-align:baseline}textarea{overflow:auto}[type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0}[type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{height:auto}[type="search"]{-webkit-appearance:textfield;outline-offset:-2px}[type="search"]::-webkit-search-cancel-button,[type="search"]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details,menu{display:block}summary{display:list-item;outline:none}canvas{display:inline-block}template{display:none}[hidden]{display:none}*,*::before,*::after{box-sizing:inherit}html{box-sizing:border-box;font-size:20px;line-height:1.5;-webkit-tap-highlight-color:transparent}body{background:#303742;color:#fff;font-family:-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;font-size:.8rem;overflow-x:hidden;text-rendering:optimizeLegibility}a{color:#73c6ec;outline:none;text-decoration:none}a:focus{box-shadow:0 0 0 0.1rem rgba(115,198,236,0.2)}a:focus,a:hover,a:active,a.active{color:#46b4e6;text-decoration:underline}a:visited{color:#a0d8f2}h1,h2,h3,h4,h5,h6{color:inherit;font-weight:700;line-height:1.2;margin-bottom:.5rem;margin-top:0}.h1,.h2,.h3,.h4,.h5,.h6{font-weight:700}h1,.h1{font-size:2rem}h2,.h2{font-size:1.6rem}h3,.h3{font-size:1.4rem}h4,.h4{font-size:1.2rem}h5,.h5{font-size:1rem}h6,.h6{font-size:.8rem}p{margin:0 0 1.2rem}a,ins,u{text-decoration-skip:ink edges}abbr[title]{border-bottom:.05rem dotted;cursor:help;text-decoration:none}kbd{border-radius:.1rem;line-height:1.2;padding:.1rem .2rem;background:#303742;color:#fff;font-size:.7rem}mark{background:#ffe9b3;color:#fff;border-bottom:.05rem solid #ffd367;border-radius:.1rem;padding:.05rem .1rem 0}blockquote{border-left:.1rem solid #dadee4;margin-left:0;padding:.4rem .8rem}blockquote p:last-child{margin-bottom:0}ul,ol{margin:.8rem 0 .8rem .8rem;padding:0}ul ul,ul ol,ol ul,ol ol{margin:.8rem 0 .8rem .8rem}ul li,ol li{margin-top:.4rem}ul{list-style:disc inside}ul ul{list-style-type:circle}ol{list-style:decimal inside}ol ol{list-style-type:lower-alpha}dl dt{font-weight:bold}dl dd{margin:.4rem 0 .8rem 0}.btn{appearance:none;background:#fff;border:.05rem solid #73c6ec;border-radius:.1rem;color:#73c6ec;cursor:pointer;display:inline-block;font-size:.8rem;height:2.5rem;line-height:1.2rem;outline:none;padding:.6rem .4rem;text-align:center;text-decoration:none;transition:background .2s, border .2s, box-shadow .2s, color .2s;user-select:none;vertical-align:middle;white-space:nowrap}.btn:focus{box-shadow:0 0 0 0.1rem rgba(115,198,236,0.2)}.btn:focus,.btn:hover{background:#fff;border-color:#66c1ea;text-decoration:none}.btn:active,.btn.active{background:#66c1ea;border-color:#4fb7e7;color:#fff;text-decoration:none}.btn:active.loading::after,.btn.active.loading::after{border-bottom-color:#fff;border-left-color:#fff}.btn[disabled],.btn:disabled,.btn.disabled{cursor:default;opacity:.5;pointer-events:none}.btn.btn-primary{background:#73c6ec;border-color:#66c1ea;color:#fff}.btn.btn-primary:focus,.btn.btn-primary:hover{background:#5dbde9;border-color:#4fb7e7;color:#fff}.btn.btn-primary:active,.btn.btn-primary.active{background:#54b9e8;border-color:#46b4e6;color:#fff}.btn.btn-primary.loading::after{border-bottom-color:#fff;border-left-color:#fff}.btn.btn-success{background:#32b643;border-color:#2faa3f;color:#fff}.btn.btn-success:focus{box-shadow:0 0 0 0.1rem rgba(50,182,67,0.2)}.btn.btn-success:focus,.btn.btn-success:hover{background:#30ae40;border-color:#2da23c;color:#fff}.btn.btn-success:active,.btn.btn-success.active{background:#2a9a39;border-color:#278e34;color:#fff}.btn.btn-success.loading::after{border-bottom-color:#fff;border-left-color:#fff}.btn.btn-error{background:#e85600;border-color:#d95000;color:#fff}.btn.btn-error:focus{box-shadow:0 0 0 0.1rem rgba(232,86,0,0.2)}.btn.btn-error:focus,.btn.btn-error:hover{background:#de5200;border-color:#cf4d00;color:#fff}.btn.btn-error:active,.btn.btn-error.active{background:#c44900;border-color:#b54300;color:#fff}.btn.btn-error.loading::after{border-bottom-color:#fff;border-left-color:#fff}.btn.btn-link{background:transparent;border-color:transparent;color:#73c6ec}.btn.btn-link:focus,.btn.btn-link:hover,.btn.btn-link:active,.btn.btn-link.active{color:#46b4e6}.btn.btn-sm{font-size:.7rem;height:1.4rem;padding:.05rem .3rem}.btn.btn-lg{font-size:.9rem;height:2rem;padding:.35rem .6rem}.btn.btn-block{display:block;width:100%}.btn.btn-action{width:2.5rem;padding-left:0;padding-right:0}.btn.btn-action.btn-sm{width:1.4rem}.btn.btn-action.btn-lg{width:2rem}.btn.btn-clear{background:transparent;border:0;color:currentColor;height:1rem;line-height:.8rem;margin-left:.2rem;margin-right:-2px;opacity:1;padding:.1rem;text-decoration:none;width:1rem}.btn.btn-clear:focus,.btn.btn-clear:hover{background:rgba(48,55,66,0.5);opacity:.95}.btn.btn-clear::before{content:"\2715"}.btn-group{display:inline-flex;flex-wrap:wrap}.btn-group .btn{flex:1 0 auto}.btn-group .btn:first-child:not(:last-child){border-bottom-right-radius:0;border-top-right-radius:0}.btn-group .btn:not(:first-child):not(:last-child){border-radius:0;margin-left:-.05rem}.btn-group .btn:last-child:not(:first-child){border-bottom-left-radius:0;border-top-left-radius:0;margin-left:-.05rem}.btn-group .btn:focus,.btn-group .btn:hover,.btn-group .btn:active,.btn-group .btn.active{z-index:1}.btn-group.btn-group-block{display:flex}.btn-group.btn-group-block .btn{flex:1 0 0}.label{border-radius:.1rem;line-height:1.2;padding:.1rem .2rem;background:#39414e;color:#e6e6e6;display:inline-block}.label.label-rounded{border-radius:5rem;padding-left:.4rem;padding-right:.4rem}.label.label-primary{background:#0b3e55;color:#fff}.label.label-secondary{background:#fff;color:#73c6ec}.label.label-success{background:#32b643;color:#fff}.label.label-warning{background:#ffb700;color:#fff}.label.label-error{background:#e85600;color:#fff}code{border-radius:.1rem;line-height:1.2;padding:.1rem .2rem;background:#0f4e6b;color:#fff;font-size:85%}.code{border-radius:.1rem;color:#fff;position:relative}.code::before{color:#bcc3ce;content:attr(data-lang);font-size:.7rem;position:absolute;right:.4rem;top:.1rem}.code code{background:#303742;color:inherit;display:block;line-height:1.5;overflow-x:auto;padding:1rem;width:100%}.container{margin-left:auto;margin-right:auto;padding-left:.4rem;padding-right:.4rem;width:100%}.container.grid-xl{max-width:1296px}.container.grid-lg{max-width:976px}.container.grid-md{max-width:856px}.container.grid-sm{max-width:616px}.container.grid-xs{max-width:496px}.show-xs,.show-sm,.show-md,.show-lg,.show-xl{display:none !important}.columns{display:flex;flex-wrap:wrap;margin-left:-.4rem;margin-right:-.4rem}.columns.col-gapless{margin-left:0;margin-right:0}.columns.col-gapless>.column{padding-left:0;padding-right:0}.columns.col-oneline{flex-wrap:nowrap;overflow-x:auto}.column{flex:1;max-width:100%;padding-left:.4rem;padding-right:.4rem}.column.col-12,.column.col-11,.column.col-10,.column.col-9,.column.col-8,.column.col-7,.column.col-6,.column.col-5,.column.col-4,.column.col-3,.column.col-2,.column.col-1{flex:none}.col-12{width:100%}.col-11{width:91.66666667%}.col-10{width:83.33333333%}.col-9{width:75%}.col-8{width:66.66666667%}.col-7{width:58.33333333%}.col-6{width:50%}.col-5{width:41.66666667%}.col-4{width:33.33333333%}.col-3{width:25%}.col-2{width:16.66666667%}.col-1{width:8.33333333%}.col-auto{flex:0 0 auto;max-width:none;width:auto}.col-mx-auto{margin-left:auto;margin-right:auto}.col-ml-auto{margin-left:auto}.col-mr-auto{margin-right:auto}@media (max-width: 1280px){.col-xl-12,.col-xl-11,.col-xl-10,.col-xl-9,.col-xl-8,.col-xl-7,.col-xl-6,.col-xl-5,.col-xl-4,.col-xl-3,.col-xl-2,.col-xl-1{flex:none}.col-xl-12{width:100%}.col-xl-11{width:91.66666667%}.col-xl-10{width:83.33333333%}.col-xl-9{width:75%}.col-xl-8{width:66.66666667%}.col-xl-7{width:58.33333333%}.col-xl-6{width:50%}.col-xl-5{width:41.66666667%}.col-xl-4{width:33.33333333%}.col-xl-3{width:25%}.col-xl-2{width:16.66666667%}.col-xl-1{width:8.33333333%}.hide-xl{display:none !important}.show-xl{display:block !important}}@media (max-width: 960px){.col-lg-12,.col-lg-11,.col-lg-10,.col-lg-9,.col-lg-8,.col-lg-7,.col-lg-6,.col-lg-5,.col-lg-4,.col-lg-3,.col-lg-2,.col-lg-1{flex:none}.col-lg-12{width:100%}.col-lg-11{width:91.66666667%}.col-lg-10{width:83.33333333%}.col-lg-9{width:75%}.col-lg-8{width:66.66666667%}.col-lg-7{width:58.33333333%}.col-lg-6{width:50%}.col-lg-5{width:41.66666667%}.col-lg-4{width:33.33333333%}.col-lg-3{width:25%}.col-lg-2{width:16.66666667%}.col-lg-1{width:8.33333333%}.hide-lg{display:none !important}.show-lg{display:block !important}}@media (max-width: 840px){.col-md-12,.col-md-11,.col-md-10,.col-md-9,.col-md-8,.col-md-7,.col-md-6,.col-md-5,.col-md-4,.col-md-3,.col-md-2,.col-md-1{flex:none}.col-md-12{width:100%}.col-md-11{width:91.66666667%}.col-md-10{width:83.33333333%}.col-md-9{width:75%}.col-md-8{width:66.66666667%}.col-md-7{width:58.33333333%}.col-md-6{width:50%}.col-md-5{width:41.66666667%}.col-md-4{width:33.33333333%}.col-md-3{width:25%}.col-md-2{width:16.66666667%}.col-md-1{width:8.33333333%}.hide-md{display:none !important}.show-md{display:block !important}}@media (max-width: 600px){.col-sm-12,.col-sm-11,.col-sm-10,.col-sm-9,.col-sm-8,.col-sm-7,.col-sm-6,.col-sm-5,.col-sm-4,.col-sm-3,.col-sm-2,.col-sm-1{flex:none}.col-sm-12{width:100%}.col-sm-11{width:91.66666667%}.col-sm-10{width:83.33333333%}.col-sm-9{width:75%}.col-sm-8{width:66.66666667%}.col-sm-7{width:58.33333333%}.col-sm-6{width:50%}.col-sm-5{width:41.66666667%}.col-sm-4{width:33.33333333%}.col-sm-3{width:25%}.col-sm-2{width:16.66666667%}.col-sm-1{width:8.33333333%}.hide-sm{display:none !important}.show-sm{display:block !important}}@media (max-width: 480px){.col-xs-12,.col-xs-11,.col-xs-10,.col-xs-9,.col-xs-8,.col-xs-7,.col-xs-6,.col-xs-5,.col-xs-4,.col-xs-3,.col-xs-2,.col-xs-1{flex:none}.col-xs-12{width:100%}.col-xs-11{width:91.66666667%}.col-xs-10{width:83.33333333%}.col-xs-9{width:75%}.col-xs-8{width:66.66666667%}.col-xs-7{width:58.33333333%}.col-xs-6{width:50%}.col-xs-5{width:41.66666667%}.col-xs-4{width:33.33333333%}.col-xs-3{width:25%}.col-xs-2{width:16.66666667%}.col-xs-1{width:8.33333333%}.hide-xs{display:none !important}.show-xs{display:block !important}}.navbar{align-items:stretch;display:flex;flex-wrap:wrap;justify-content:space-between;margin-left:auto;margin-right:auto;max-width:960px}.navbar .navbar-section{align-items:center;display:flex;flex:1 0 0}.navbar .navbar-section:not(:first-child):last-child{justify-content:flex-end}.navbar .navbar-center{align-items:center;display:flex;flex:0 0 auto}.navbar .navbar-brand{font-size:.9rem;text-decoration:none}pre{padding:0.5rem 0.5rem;border-radius:.3rem;overflow-y:auto}.post header{border-radius:.3rem;padding:0.5rem;margin-bottom:0.5rem}.post header h1{margin-bottom:0}.post section{padding:0.5rem;background-color:#2a3039;border-radius:.3rem}.post img{width:100%}.post .utterances{max-width:none !important}.card{margin-bottom:0.5rem}.main-header{margin-bottom:0.5rem;background-color:#272d36;box-shadow:0 20rem 20rem 20rem rgba(115,198,236,0.2)}.card{background:#2a3039;border-radius:.3rem;display:flex;flex-direction:column}.card .card-header,.card .card-body,.card .card-footer{padding:.8rem;padding-bottom:0}.card .card-header:last-child,.card .card-body:last-child,.card .card-footer:last-child{padding-bottom:.8rem}.card .card-body{flex:1 1 auto}.card .card-image{padding-top:.8rem}.card .card-image:first-child{padding-top:0}.card .card-image:first-child img{border-top-left-radius:.1rem;border-top-right-radius:.1rem}.card .card-image:last-child img{border-bottom-left-radius:.1rem;border-bottom-right-radius:.1rem}
</style>
</head>

<body>
    <header class="main-header">
        <div class="navbar">
        <section class="navbar-section">
            <img src="/favicon.svg" width="30" height="30"/>
            <a href="/" class="btn btn-link">Home</a>
            <a href="/blog/" class="btn btn-link">Blogs</a>
            <a href="/rss.xml" class="btn btn-link">RSS</a>
        </section>
        <section class="navbar-center">
        </section>
        <section class="navbar-section">
            <a href="https://github.com/cetra3/" class="btn btn-link">GitHub</a>
            <a href="https://twitter.com/cetra3" class="btn btn-link">Twitter</a>
            <a href="https://mastodon.social/@cetra3" class="btn btn-link">Mastodon</a>
        </section>
        </div>
    </header>
    <div class="container grid-lg">
        
<article class="post">
  <header>
  <h1>Implementing a Job queue with SQLx and Postgres </h1>
  <em>An example of async postgres in rust</em>
  <br />
  
  <small class="label label-primary">rust</small> <small class="label label-primary">tmq</small> <small class="label label-primary">sqlx</small> <small class="label">2020-06-26</small>
  
  </header>
  <section>
    <p><strong>SQLx</strong> is a new <a href="https://github.com/launchbadge/sqlx">async SQL Toolkit</a> for rust that is closer to standard SQL than a more opinionated ORM like <a href="http://diesel.rs/">Diesel</a>. I wanted to give it a bit of a test run and see how easy it would be to convert usage from <a href="https://github.com/sfackler/rust-postgres">tokio-postgres</a>.  So as the next saga in the jobq series (<a href="../implementing-a-jobq/">part 1</a>, <a href="../implementing-a-jobq-with-tokio/">part 2</a>), we will be converting <a href="https://github.com/cetra3/jobq">jobq</a> crate to use <code>sqlx</code>.  You can find the <em>SQLx</em> branch here: <a href="https://github.com/cetra3/jobq/tree/sqlx">https://github.com/cetra3/jobq/tree/sqlx</a></p>
<p>As a little spoiler: I found it quite easy to adjust and a pleasure to use but found the documentation a little lacking.</p>
<h2 id="object-relational-mappers-orms">Object Relational Mappers (ORMs)</h2>
<p><strong>ORMs</strong> definitely serve a purpose. <em>ORMs</em> provide an opinionated way to manage the database schema and craft queries in an easy way.  Normally you construct queries using builders, or other language constructs, and get given the results back straight in your language types (structs in the case of rust).  Migration is a lot easier as most offer a managed way to run migrations for you.  You don't need to know SQL either, and can simply run functions in your language to build up queries to the database.</p>
<p>Writing raw SQL in some ORMs is a second class citizen, which is where I have a problem.  I personally find the cognitive load of having to wrangle the builder pattern to pull out SQL is not worth it.  I am quite comfortable writing SQL and have done for many years, and so I have steered away from using highly opinionated ORMs in the past.  In the world of Java I much prefer <a href="https://mybatis.org/mybatis-3/">MyBatis</a> or <a href="http://jdbi.org/">Jdbi</a> over <a href="https://hibernate.org/">Hibernate</a>.  In Rust, I am using standard <a href="https://github.com/sfackler/rust-postgres">tokio-postgres</a> over <a href="http://diesel.rs/">diesel</a> for the same reasons (that: and diesel async support is not there yet and <a href="https://github.com/diesel-rs/diesel/issues/399">doesn't look like it will be</a> anytime soon...).</p>
<p>Now if you are not familiar with SQL this is definitely a different story, and may find you have a different opinion on how productive you are.  That's fine too, as this is one reason ORMs exist: to make it easier to code.  I would still recommend spending time grokking SQL, as it is quite a great skill to have in your toolbox.</p>
<h3 id="diesel-orm">Diesel ORM</h3>
<p>Picking on <a href="http://diesel.rs/">diesel</a> for a second: here is their <em>Complex Queries</em> example:</p>
<pre style="background-color:#212733;">
<span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> versions </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">Version</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">belonging_to(krate)
  </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">select</span><span style="color:#ccc9c2;">(id)
  </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">order</span><span style="color:#ccc9c2;">(num</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">desc</span><span style="color:#ccc9c2;">())
  </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">limit</span><span style="color:#ccc9c2;">(</span><span style="color:#ffcc66;">5</span><span style="color:#ccc9c2;">)</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> downloads </span><span style="color:#f29e74;">=</span><span style="color:#ccc9c2;"> version_downloads
  </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">filter</span><span style="color:#ccc9c2;">(date</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">gt</span><span style="color:#ccc9c2;">(now </span><span style="color:#f29e74;">- </span><span style="color:#ffcc66;">90.</span><span style="color:#f28779;">days</span><span style="color:#ccc9c2;">()))
  </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">filter</span><span style="color:#ccc9c2;">(version_id</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">eq</span><span style="color:#ccc9c2;">(</span><span style="color:#f28779;">any</span><span style="color:#ccc9c2;">(versions)))
  </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">order</span><span style="color:#ccc9c2;">(date)
  </span><span style="color:#f29e74;">.</span><span style="color:#ccc9c2;">load</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">&lt;Download&gt;(</span><span style="color:#f29e74;">&amp;</span><span style="color:#ccc9c2;">conn)</span><span style="color:#f29e74;">?</span><span style="color:#ccc9c2cc;">;
</span></pre>
<p>Here is the same query in SQL:</p>
<pre style="background-color:#212733;">
<span style="color:#ffa759;">SELECT</span><span style="color:#ccc9c2;"> version_downloads.</span><span style="color:#f29e74;">*
  </span><span style="color:#ffa759;">WHERE date </span><span style="color:#f29e74;">&gt;</span><span style="color:#ccc9c2;"> (NOW() </span><span style="color:#f29e74;">- </span><span style="color:#bae67e;">&#39;90 days&#39;</span><span style="color:#ccc9c2;">)
    </span><span style="color:#ffa759;">AND</span><span style="color:#ccc9c2;"> version_id </span><span style="color:#f29e74;">=</span><span style="color:#ccc9c2;"> ANY(
      </span><span style="color:#ffa759;">SELECT</span><span style="color:#ccc9c2;"> id </span><span style="color:#ffa759;">FROM</span><span style="color:#ccc9c2;"> versions
        </span><span style="color:#ffa759;">WHERE</span><span style="color:#ccc9c2;"> crate_id </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">1
        </span><span style="color:#ffa759;">ORDER BY</span><span style="color:#ccc9c2;"> num </span><span style="color:#ffa759;">DESC
        LIMIT </span><span style="color:#ffcc66;">5</span><span style="color:#ccc9c2;">
    )
  </span><span style="color:#ffa759;">ORDER BY date
</span></pre>
<p>Which one do you find more readable? I find the SQL easier to read.</p>
<h3 id="sqlx-orm">SQLx ORM</h3>
<p>I still consider <code>SQLx</code> an ORM, but with SQL as a first-class citizen.</p>
<p>Here's how you'd do the same with <strong>SQLx</strong>:</p>
<pre style="background-color:#212733;">
<span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> query </span><span style="color:#f29e74;">= </span><span style="color:#bae67e;">&quot;SELECT version_downloads.*
  WHERE date &gt; (NOW() - &#39;90 days&#39;)
    AND version_id = ANY(
      SELECT id FROM versions
        WHERE crate_id = $1
        ORDER BY num DESC
        LIMIT 5
    )
  ORDER BY date&quot;</span><span style="color:#ccc9c2cc;">;


</span><span style="color:#ccc9c2;">sqlx</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">query_as(query)
    </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">bind</span><span style="color:#ccc9c2;">(</span><span style="color:#f29e74;">&amp;</span><span style="color:#ccc9c2;">num)
    </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">fetch_all</span><span style="color:#ccc9c2;">(</span><span style="color:#f29e74;">&amp;*</span><span style="font-style:italic;color:#5ccfe6;">self</span><span style="color:#f29e74;">.</span><span style="color:#ccc9c2;">pool)</span><span style="color:#ccc9c2cc;">;
</span></pre>
<p>If your <code>Version</code> struct derived <code>sqlx::FromRow</code>, then this would all work nicely.</p>
<h2 id="converting-to-sqlx">Converting to SQLx</h2>
<p>Converting to SQLx was a mostly painless experience, and only <a href="https://github.com/cetra3/jobq/compare/051b2c2a89fbed0a67bc989c4d3bf29a745ab3ce...sqlx">very minimal changes</a> were needed for the jobq code base.  In the end, only the structs &amp; db files were needed to be adjusted, but I could reuse all of the query strings and sql building logic.</p>
<p>As I am not starting with SQLx, some of the touted features I didn't use (like <a href="https://github.com/launchbadge/sqlx#compile-time-verification">compile time verification</a>).  There were also a few gotchas I ran into, but did not find it hard to work through them after a bit of reading.</p>
<h3 id="migrations-and-raw-sql">Migrations and Raw SQL</h3>
<p>I haven't implemented migrations properly in jobq: it's just a <a href="https://github.com/cetra3/jobq/blob/sqlx/src/setup.sql">simple sql script</a> that is run at startup.  SQLx does have <a href="https://github.com/launchbadge/sqlx/tree/master/sqlx-cli">utilities for this</a>, and is also quite strong on <a href="https://github.com/launchbadge/sqlx#compile-time-verification">compile time verification</a> to make this more type safe.</p>
<p><strong>However:</strong> I just want to run the script at startup.  It's simple &amp; I can do it from standard postgres cli, so I should be able to it simply from rust as well.  The <code>sqlx::query</code> method will convert the SQL to a prepared statement, which does not play nice with such a query:</p>
<pre style="background-color:#212733;">
<span style="color:#ccc9c2;">sqlx</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">query(</span><span style="color:#f28779;">include_str!</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot;setup.sql&quot;</span><span style="color:#ccc9c2;">))</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">execute</span><span style="color:#ccc9c2;">(</span><span style="color:#f29e74;">&amp;</span><span style="color:#ccc9c2;">pool)</span><span style="color:#f29e74;">.</span><span style="color:#ccc9c2;">await</span><span style="color:#f29e74;">?</span><span style="color:#ccc9c2cc;">;
</span></pre>
<p>Here's the error you may get:</p>
<pre style="background-color:#212733;">
<span style="color:#ccc9c2;">cannot insert multiple commands into a prepared statement
</span></pre>
<p>Instead, you can use the <a href="https://docs.rs/sqlx/0.3.5/sqlx/trait.Executor.html"><code>Executor</code> trait</a> which is implemented for <code>&amp;PgPool</code>.  This does make it a little awkward to write having to have the extra brackets:</p>
<pre style="background-color:#212733;">
<span style="color:#ccc9c2;">(</span><span style="color:#f29e74;">&amp;</span><span style="color:#ccc9c2;">pool)</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">execute</span><span style="color:#ccc9c2;">(</span><span style="color:#f28779;">include_str!</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot;setup.sql&quot;</span><span style="color:#ccc9c2;">))</span><span style="color:#f29e74;">.</span><span style="color:#ccc9c2;">await</span><span style="color:#f29e74;">?</span><span style="color:#ccc9c2cc;">;
</span></pre><h3 id="mapping-a-postgresql-query-to-rust-structs">Mapping a postgresql query to rust structs</h3>
<p>sqlx has a <code>query_as</code> method which allows you to convert returned result rows into rust structs, a bit like serde is used to serialize/deserialize data.</p>
<p>This works by deriving <a href="https://docs.rs/sqlx/0.3.5/sqlx/derive.FromRow.html"><code>sqlx::FromRow</code></a> on your structs:</p>
<pre style="background-color:#212733;">
<span style="color:#ccc9c2cc;">#</span><span style="color:#ccc9c2;">[</span><span style="color:#ffd580;">derive</span><span style="color:#ccc9c2;">(Serialize</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> Deserialize</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> Debug</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> Clone</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> sqlx::FromRow)]
</span><span style="color:#ffa759;">pub struct </span><span style="color:#73d0ff;">Job </span><span style="color:#ccc9c2;">{
    </span><span style="color:#ffa759;">pub </span><span style="color:#ccc9c2;">id</span><span style="color:#ccc9c2cc;">: </span><span style="color:#ffa759;">i64</span><span style="color:#ccc9c2;">,
    </span><span style="color:#ffa759;">pub </span><span style="color:#ccc9c2;">username</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ccc9c2;"> String,
    </span><span style="color:#ffa759;">pub </span><span style="color:#ccc9c2;">name</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ccc9c2;"> String,
    </span><span style="color:#ffa759;">pub </span><span style="color:#ccc9c2;">uuid</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ccc9c2;"> Uuid,
    </span><span style="color:#ffa759;">pub </span><span style="color:#ccc9c2;">params</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ccc9c2;"> Value,
    </span><span style="color:#ffa759;">pub </span><span style="color:#ccc9c2;">priority</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ccc9c2;"> Priority,
    </span><span style="color:#ffa759;">pub </span><span style="color:#ccc9c2;">status</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ccc9c2;"> Status,
}
</span></pre>
<p>As I am using <a href="https://github.com/cetra3/jobq/blob/f4441203fd4b4d2d73d5f7a91b228723c7330aa6/src/setup.sql#L2-L9">custom enums</a>, I also need to derive <a href="https://docs.rs/sqlx/0.3.5/sqlx/derive.Type.html"><code>sqlx::Type</code></a> on them:</p>
<pre style="background-color:#212733;">
<span style="color:#ccc9c2cc;">#</span><span style="color:#ccc9c2;">[</span><span style="color:#ffd580;">derive</span><span style="color:#ccc9c2;">(Serialize</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> Deserialize</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> Debug</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> Clone</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> sqlx::Type)]
</span><span style="color:#ffa759;">pub enum </span><span style="color:#73d0ff;">Status </span><span style="color:#ccc9c2;">{
    Queued</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;">
    Processing</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;">
    Completed</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;">
    Failed</span><span style="color:#ccc9c2cc;">,
</span><span style="color:#ccc9c2;">}
</span></pre>
<p>(<em>Side note: custom enums may not be a <a href="https://softwareengineering.stackexchange.com/questions/305148/why-would-you-store-an-enum-in-db">hot idea for maintainability</a></em>)</p>
<p>With that I can do away with the old <a href="https://github.com/cetra3/jobq/blob/051b2c2a89fbed0a67bc989c4d3bf29a745ab3ce/src/db.rs#L53-L79"><code>get_jobs</code></a> method, as this is handled for me now by SQLx.</p>
<p>I can then use the <a href="https://docs.rs/sqlx/0.3.5/sqlx/postgres/trait.PgQueryAs.html#tymethod.fetch_all"><code>fetch_all</code></a> method to return is as a <code>Vec</code>:</p>
<pre style="background-color:#212733;">
<span style="color:#ffa759;">pub</span><span style="color:#ccc9c2;">(</span><span style="color:#ffa759;">crate</span><span style="color:#ccc9c2;">) async </span><span style="color:#ffa759;">fn </span><span style="color:#ffd580;">get_processing_jobs</span><span style="color:#ccc9c2;">(</span><span style="color:#f29e74;">&amp;</span><span style="color:#ffcc66;">self</span><span style="color:#ccc9c2;">) </span><span style="color:#ccc9c2cc;">-&gt; </span><span style="color:#ccc9c2;">Result&lt;Vec&lt;Job&gt;, Error&gt; {
    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> query </span><span style="color:#f29e74;">= </span><span style="color:#bae67e;">&quot;select id, name, username, uuid, params, priority, status from jobq
                 where status = &#39;Processing&#39; order by priority asc, time asc&quot;</span><span style="color:#ccc9c2cc;">;

    </span><span style="font-style:italic;color:#5ccfe6;">Ok</span><span style="color:#ccc9c2;">(sqlx</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">query_as(query)</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">fetch_all</span><span style="color:#ccc9c2;">(</span><span style="color:#f29e74;">&amp;*</span><span style="font-style:italic;color:#5ccfe6;">self</span><span style="color:#f29e74;">.</span><span style="color:#ccc9c2;">pool)</span><span style="color:#f29e74;">.</span><span style="color:#ccc9c2;">await</span><span style="color:#f29e74;">?</span><span style="color:#ccc9c2;">)
}
</span></pre>
<p>Worthy of note: the <a href="https://docs.rs/sqlx/0.3.5/sqlx/postgres/trait.PgQueryAs.html#tymethod.fetch"><code>fetch</code></a> method returns a futures <code>Stream</code> to iterate through, making a much tighter integration with async</p>
<h3 id="binding-parameters">Binding Parameters</h3>
<p>I didn't need to change SQL statements at all, but did need to adjust some of the binding parameters using the <code>bind</code> builder pattern:</p>
<pre style="background-color:#212733;">
<span style="color:#ffa759;">pub</span><span style="color:#ccc9c2;">(</span><span style="color:#ffa759;">crate</span><span style="color:#ccc9c2;">) async </span><span style="color:#ffa759;">fn </span><span style="color:#ffd580;">complete_job</span><span style="color:#ccc9c2;">(</span><span style="color:#f29e74;">&amp;</span><span style="color:#ffcc66;">self</span><span style="color:#ccc9c2;">, </span><span style="color:#ffcc66;">id</span><span style="color:#ccc9c2cc;">: </span><span style="color:#ffa759;">i64</span><span style="color:#ccc9c2;">) </span><span style="color:#ccc9c2cc;">-&gt; </span><span style="color:#ccc9c2;">Result&lt;(), Error&gt; {
    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> query </span><span style="color:#f29e74;">= </span><span style="color:#bae67e;">&quot;update jobq set status = &#39;Completed&#39;, duration = extract(epoch from now() - </span><span style="color:#95e6cb;">\&quot;</span><span style="color:#bae67e;">time</span><span style="color:#95e6cb;">\&quot;</span><span style="color:#bae67e;">) where id = $1&quot;</span><span style="color:#ccc9c2cc;">;

    </span><span style="color:#ccc9c2;">sqlx</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">query(query)</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">bind</span><span style="color:#ccc9c2;">(</span><span style="color:#f29e74;">&amp;</span><span style="color:#ccc9c2;">id)</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">execute</span><span style="color:#ccc9c2;">(</span><span style="color:#f29e74;">&amp;*</span><span style="font-style:italic;color:#5ccfe6;">self</span><span style="color:#f29e74;">.</span><span style="color:#ccc9c2;">pool)</span><span style="color:#f29e74;">.</span><span style="color:#ccc9c2;">await</span><span style="color:#f29e74;">?</span><span style="color:#ccc9c2cc;">;

    </span><span style="font-style:italic;color:#5ccfe6;">Ok</span><span style="color:#ccc9c2;">(())
}
</span></pre>
<p>This is different to <code>tokio-postgres</code> accepting an array of parameters.  I have ran into issues before when trying to pass dynamic arguments and trying to wrangle life times.  Here is how I have worked around this in the past (not exactly pretty):</p>
<pre style="background-color:#212733;">
<span style="color:#ffa759;">for</span><span style="color:#ccc9c2;"> row </span><span style="color:#f29e74;">in </span><span style="font-style:italic;color:#5ccfe6;">self</span><span style="color:#f29e74;">.</span><span style="color:#ccc9c2;">pool</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">get</span><span style="color:#ccc9c2;">()</span><span style="color:#f29e74;">?.</span><span style="color:#f28779;">query</span><span style="color:#ccc9c2;">(
    </span><span style="color:#f29e74;">&amp;*</span><span style="color:#ccc9c2;">query</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;">
    params
        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">iter</span><span style="color:#ccc9c2;">()
        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">map</span><span style="color:#ccc9c2;">(|</span><span style="color:#ffcc66;">val</span><span style="color:#ccc9c2;">| </span><span style="color:#f29e74;">&amp;**</span><span style="color:#ccc9c2;">val </span><span style="color:#f29e74;">as &amp;</span><span style="color:#ccc9c2;">(dyn ToSql </span><span style="color:#f29e74;">+ </span><span style="font-style:italic;color:#5ccfe6;">Sync</span><span style="color:#ccc9c2;">))
        </span><span style="color:#f29e74;">.</span><span style="color:#ccc9c2;">collect</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">&lt;Vec&lt;</span><span style="color:#f29e74;">_</span><span style="color:#ccc9c2;">&gt;&gt;()
        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">as_slice</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">,
</span><span style="color:#ccc9c2;">)</span><span style="color:#f29e74;">?
</span></pre><h2 id="conclusions">Conclusions</h2>
<p>As you can see from the <a href="https://github.com/cetra3/jobq/compare/051b2c2a89fbed0a67bc989c4d3bf29a745ab3ce...sqlx">diff of the commits</a>, the conversion to use SQLx was an easy excercise.  I have found SQLx quite a bit more lightweight and more to my liking than some of the heavier ORMs I've dealt with in the past.  Being async first means that this will be a great fit for the ecosystem: I can see it becoming the defacto async story for databases in the future.</p>
<p>One area which may need some improvement is the documentation &amp; examples.  As it is a comparitively young library with the <a href="https://github.com/launchbadge/sqlx/commit/d29b24abf0f491d912333f34d7b5187e4c30bb08">first commit a year ago</a>, I assume that this will only get better with time.  The <a href="https://github.com/launchbadge/sqlx">README</a>  and <a href="https://docs.rs/sqlx">api docs</a> were enough for me to get into trouble.</p>
<p>If you are looking to talk to a database with async rust, make sure you consider SQLx!</p>

  </section>
</article>


    </div>
    <script async defer data-domain="cetra3.github.io" src="https://plausible.io/js/plausible.js"></script>
</body>

</html>